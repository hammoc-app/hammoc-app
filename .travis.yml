language: elixir
elixir: '1.8.0'
otp_release: '21.1.1'

before_install:
  - docker run -d --name postgres11 -p 5433:5432 -e 'POSTGRES_PASSWORD=postgres' postgres:11.1-alpine
  - docker exec -i postgres11 bash <<< 'until pg_isready -U postgres > /dev/null 2>&1 ; do sleep 1; done'

env:
  - DB_PORT=5433

install:
  - mix compile
  - MIX_ENV=test mix compile

jobs:
  include:
    - stage: test
      name: Compile warnings
      script: mix compile --warnings-as-errors
    - stage: test
      name: Code conventions
      script: mix credo
    - stage: test
      name: Code format
      script: mix format --check-formatted --dry-run
    - stage: test
      name: Static code analysis (dev)
      script: mix dialyzer --halt-exit-status
    - stage: test
      name: Static code analysis (test)
      script: MIX_ENV=test mix dialyzer --halt-exit-status
    - stage: test
      name: Test suite
      script: mix test

cache:
  directories:
    - _build
    - deps

before_cache:
  - rm _build/*/lib/hammoc/.mix/compile.elixir
